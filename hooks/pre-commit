#!/usr/bin/env ruby

require 'rubygems'
require 'netrc'
require 'git-sleep'
require 'httparty'

netrc = Netrc.read(GitSleep::NETRC_PATH)
xid = netrc["sleepytime.com"].first

raise "Need to `git sleep authorize`" if xid.nil?

response = HTTParty.get(
  "http://localhost:3000/api/need_sleep",
  :body => {
    :xid => xid
  }
)

if response.response.code.to_i == 200
  data = response.parsed_response
  if data["can_commit"]
    puts "Great job #{ENV['USER']}! You slept #{data['sleep24']} hours in the last 24 hours"
  else
    puts "You have only slept #{data["sleep24"]} hours in the last 24 hours!!"
    puts "You'll have to git some sleep #{ENV["USER"]} before you can commit again"
    puts "(if you're sure you want to commit right now, run: git commit --no-verify)"
    exit(1)
  end
elsif response.response.code.to_i == 401
  puts "Must first authorize at #{GitSleep::OUR_SITE}"
  puts "Then run `git sleep authorize`"
else
  # could not communicate with our server
  # uh oh!
end
